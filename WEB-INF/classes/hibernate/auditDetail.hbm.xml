<?xml version="1.0" encoding="UTF-8"?>
<!--
    < Ã€KURA, This application manages the daily activities of a Teacher and a Student of a School>

    Copyright (C) 2012 Virtusa Corporation.
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
-->

<!DOCTYPE hibernate-mapping PUBLIC
"-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<hibernate-mapping>
	<class name="com.virtusa.akura.api.dto.AuditDetail" table="AUDIT_DETAILS">
		<id name = "auditDetailsId"  type = "int" column="AUDIT_DETAILS_ID">
			<generator class="increment"/>
		</id>
		<property name="auditCategoryId" type="int">
			<column name="AUDIT_CATEGORY_ID" not-null="true" />
		</property>
		<property name="param0Value" type="string">
			<column name="PARAM0_VALUE" length="45" />
		</property>
		<property name="param1Value" type="string">
			<column name="PARAM1_VALUE" length="45" />
		</property>
		<property name="param2Value" type="string">
			<column name="PARAM2_VALUE" length="45" />
		</property>
		<property name="param3Value" type="string">
			<column name="PARAM3_VALUE" length="45" />
		</property>
		<property name="param4Value" type="string">
			<column name="PARAM4_VALUE" length="45" />
		</property>
		<property name="param5Value" type="string">
			<column name="PARAM5_VALUE" length="45" />
		</property>
		<property name="param6Value" type="string">
			<column name="PARAM6_VALUE" length="45" />
		</property>
		<property name="param7Value" type="string">
			<column name="PARAM7_VALUE" length="45" />
		</property>
		<property name="param8Value" type="string">
			<column name="PARAM8_VALUE" length="45" />
		</property>
		<property name="param9Value" type="string">
			<column name="PARAM9_VALUE" length="45" />
		</property>		
		<property name="userName" type="string">
			<column name="USER_NAME" length="45" not-null="true"  />
		</property>
		<property name="auditEventTypeId" type="int">
			<column name="ACTION_TYPE_ID" />			
		</property>
		<property name="modifiedTime" type="timestamp" generated="always">
			<column name="MODIFIED_TIME" length="19" not-null="true" />
		</property>		
	</class>
	
	<sql-query name="auditSearchForExamMarks">
		<![CDATA[			
		SELECT AUDIT_DETAILS.USER_NAME,
			SUBJECT.DESCRIPTION,
			STUDENT.NAME_WT_INITIALS,
			EXAM_ADMISSIONS.ADMISSION_NO,
			AUDIT_DETAILS.MODIFIED_TIME, 
			IF((EXAM.MARK_TYPE = 0 AND GR.GRADE_ACRONYM IS NOT NULL), GR.GRADE_ACRONYM, AUDIT_DETAILS.PARAM1_VALUE) AS CURRENT_VALUE,
 			AUDIT_DETAILS.AUDIT_CATEGORY_ID,
 			AUDIT_DETAILS.PARAM0_VALUE
			FROM EXAM_SUBJECT 
			JOIN EXAM_MARKS 
			JOIN AUDIT_DETAILS 			
			JOIN SUBJECT 
			JOIN STUDENT 
			JOIN EXAM_ADMISSIONS 
			JOIN STUDENT_CLASS_INFO 
			JOIN EXAM 
			LEFT JOIN GRADING GR ON EXAM.MARK_TYPE = 0 AND AUDIT_DETAILS.PARAM1_VALUE=GR.GRADING_ID
		WHERE 
			STUDENT.STUDENT_ID=EXAM_MARKS.STUDENT_ID 
			AND SUBJECT.SUBJECT_ID=EXAM_SUBJECT.SUBJECT_ID			
			AND AUDIT_DETAILS.AUDIT_CATEGORY_ID=? 
			AND AUDIT_DETAILS.PARAM0_VALUE=EXAM_MARKS.EXAM_MARKS_ID 
			AND EXAM_SUBJECT.EXAM_ID=? 
			AND EXAM_MARKS.EXAM_SUBJECT_ID = EXAM_SUBJECT.EXAM_SUBJECT_ID
			AND ( ? = '' OR  AUDIT_DETAILS.MODIFIED_TIME >= ?)
			AND ( ? = '' OR  AUDIT_DETAILS.MODIFIED_TIME <= ? )
			AND ( ? = '' OR  AUDIT_DETAILS.USER_NAME = ? )
			AND EXAM.EXAM_ID=EXAM_SUBJECT.EXAM_ID
			AND EXAM_MARKS.YEAR= ?
			AND EXAM_ADMISSIONS.EXAM_ADMISSION_ID=EXAM_MARKS.EXAM_ADMISSION_ID
			AND STUDENT_CLASS_INFO.STUDENT_ID=STUDENT.STUDENT_ID 
 			AND STUDENT_CLASS_INFO.CLASS_GRADE_ID=?
 			AND STUDENT_CLASS_INFO.YEAR=?
			ORDER BY AUDIT_DETAILS.MODIFIED_TIME DESC
 ;
		]]>
    </sql-query>
    
    <sql-query name="auditSearchForAssignmentMark">
		<![CDATA[
			
		SELECT AUDIT_DETAILS.USER_NAME,
				STUDENT.ADMISSION_NO,
				STUDENT.NAME_WT_INITIALS,
				IF( (ASSIGNMENT.IS_MARKS = 0 AND GR.GRADE_ACRONYM IS NOT NULL), GR.GRADE_ACRONYM, AUDIT_DETAILS.PARAM1_VALUE) AS CURRENT_VALUE ,
				AUDIT_DETAILS.MODIFIED_TIME,
				AUDIT_DETAILS.AUDIT_CATEGORY_ID,
				AUDIT_DETAILS.PARAM0_VALUE
		FROM AUDIT_DETAILS		
		JOIN STUDENT_ASSIGNMENT_MARK 
		JOIN STUDENT_CLASS_INFO 
		JOIN STUDENT 
		JOIN ASSIGNMENT 
		LEFT JOIN GRADING GR ON ASSIGNMENT.IS_MARKS=0 AND AUDIT_DETAILS.PARAM1_VALUE=GR.GRADING_ID
		WHERE AUDIT_DETAILS.AUDIT_CATEGORY_ID= ?
			AND ( ? = '' OR  AUDIT_DETAILS.USER_NAME=?)			
			AND STUDENT_ASSIGNMENT_MARK.STUDENT_ASSIGNMENT_MARKS_ID=AUDIT_DETAILS.PARAM0_VALUE
			AND STUDENT_ASSIGNMENT_MARK.ASSIGNMENT_ID=?
			AND STUDENT_ASSIGNMENT_MARK.STUDENT_CLASS_INFO_ID = STUDENT_CLASS_INFO.STUDENT_CLASS_INFO_ID
			AND STUDENT.STUDENT_ID=STUDENT_CLASS_INFO.STUDENT_ID 
			AND ( ?= '' OR  AUDIT_DETAILS.MODIFIED_TIME >= ?)
			AND ( ? = '' OR AUDIT_DETAILS.MODIFIED_TIME <= ? )
			AND STUDENT_ASSIGNMENT_MARK.YEAR=?
			AND STUDENT_CLASS_INFO.CLASS_GRADE_ID=?
			AND ASSIGNMENT.ASSIGNMENT_ID=STUDENT_ASSIGNMENT_MARK.ASSIGNMENT_ID
		ORDER BY AUDIT_DETAILS.MODIFIED_TIME DESC
;		
		]]>
    </sql-query>
    
    <sql-query name="getPreviousValueForExam">
		<![CDATA[			
			SELECT IF((EXAM.MARK_TYPE = 0 AND GR.GRADE_ACRONYM IS NOT NULL), GR.GRADE_ACRONYM, AUDIT_DETAILS.PARAM1_VALUE) AS CURRENT_VALUE
			FROM AUDIT_DETAILS JOIN EXAM_SUBJECT JOIN EXAM_MARKS JOIN EXAM 
			LEFT JOIN GRADING GR ON EXAM.MARK_TYPE = 0 
			AND AUDIT_DETAILS.PARAM1_VALUE=GR.GRADING_ID
			WHERE AUDIT_DETAILS.AUDIT_CATEGORY_ID= ? AND AUDIT_DETAILS.PARAM0_VALUE= ? 
				AND EXAM_MARKS.EXAM_SUBJECT_ID = EXAM_SUBJECT.EXAM_SUBJECT_ID
				AND EXAM.EXAM_ID=  EXAM_SUBJECT.EXAM_ID AND EXAM.EXAM_ID=?
				AND AUDIT_DETAILS.MODIFIED_TIME < ?  
				AND AUDIT_DETAILS.PARAM0_VALUE=EXAM_MARKS.EXAM_MARKS_ID
			ORDER BY AUDIT_DETAILS.MODIFIED_TIME DESC LIMIT 1
			;						
		]]>
    </sql-query>
    
    <sql-query name="getPreviousValueForAssignmentMark">
		<![CDATA[
			
			SELECT IF((ASSIGNMENT.IS_MARKS = 0 AND GR.GRADE_ACRONYM IS NOT NULL), GR.GRADE_ACRONYM, AUDIT_DETAILS.PARAM1_VALUE) AS CURRENT_VALUE
			FROM AUDIT_DETAILS JOIN ASSIGNMENT 
				JOIN STUDENT_ASSIGNMENT_MARK
				LEFT JOIN GRADING GR ON ASSIGNMENT.IS_MARKS = 0 AND AUDIT_DETAILS.PARAM1_VALUE=GR.GRADING_ID
			WHERE AUDIT_DETAILS.AUDIT_CATEGORY_ID= ? 
				AND AUDIT_DETAILS.PARAM0_VALUE= ?
 				AND ASSIGNMENT.ASSIGNMENT_ID=?
				AND AUDIT_DETAILS.MODIFIED_TIME < ? 
				AND AUDIT_DETAILS.PARAM0_VALUE=STUDENT_ASSIGNMENT_MARK.STUDENT_ASSIGNMENT_MARKS_ID
				AND ASSIGNMENT.ASSIGNMENT_ID=STUDENT_ASSIGNMENT_MARK.ASSIGNMENT_ID
			ORDER BY AUDIT_DETAILS.MODIFIED_TIME DESC LIMIT 1
;
	]]>
    </sql-query>
    
     <sql-query name="auditSearchForMarkCompletion">
		<![CDATA[
	SELECT USER_NAME, 
		MODIFIED_TIME 
	FROM AUDIT_DETAILS
	WHERE AUDIT_CATEGORY_ID=?
		AND (? = '' OR USER_NAME=? )
		AND PARAM2_VALUE= ?
		AND ( ? = '' OR MODIFIED_TIME >=?)
		AND ( ? = '' OR MODIFIED_TIME <= ?)
		AND PARAM3_VALUE=?
		AND PARAM1_VALUE=?
	;	
		]]>
    </sql-query>
	
	
	<sql-query name="getAuditDetailsListForTermMark">
		<![CDATA[
			
			SELECT AU.USER_NAME,
				S.ADMISSION_NO,
				S.NAME_WT_INITIALS,
				SUB.DESCRIPTION,
				AU.PARAM1_VALUE,
				AU.MODIFIED_TIME,
				AU.PARAM0_VALUE
			FROM AUDIT_DETAILS AU 
				JOIN STUDENT_TERM_MARK STU ON AU.PARAM0_VALUE = STU.STUDENT_TERM_MARKS_ID 
				JOIN STUDENT_CLASS_INFO STCL ON STU.STUDENT_CLASS_INFO_ID=STCL.STUDENT_CLASS_INFO_ID
				JOIN STUDENT S ON STCL.STUDENT_ID = S.STUDENT_ID 
				JOIN GRADE_SUBJECT GRD ON STU.GRADE_SUBJECT_ID = GRD.GRADE_SUBJECT_ID 
				JOIN SUBJECT SUB ON GRD.SUBJECT_ID=SUB.SUBJECT_ID 
			WHERE (? = '' OR AU.USER_NAME = ?) AND (? = '' OR AU.MODIFIED_TIME >= ?) AND (? = '' OR AU.MODIFIED_TIME <= ?)  AND STCL.CLASS_GRADE_ID = ?
			AND STCL.YEAR = ? AND STU.TERM_ID=?	AND AU.AUDIT_CATEGORY_ID=1	
			ORDER BY AU.MODIFIED_TIME DESC
		]]>
    </sql-query>
    
    <sql-query name="getPriviouseValueForTermMark">
		<![CDATA[
			SELECT PARAM1_VALUE
			FROM AUDIT_DETAILS
			WHERE AUDIT_DETAILS.AUDIT_CATEGORY_ID=1 AND AUDIT_DETAILS.PARAM0_VALUE= ? AND
			AUDIT_DETAILS.MODIFIED_TIME < ?
			ORDER BY AUDIT_DETAILS.MODIFIED_TIME DESC
					
		]]>
    </sql-query>	
	
	<sql-query name="getAuditDetailsListForSubTermMark">
		<![CDATA[
			SELECT AU.USER_NAME,
				S.ADMISSION_NO,
				S.NAME_WT_INITIALS,
				SUB.DESCRIPTION,
				SUBT.DESCRIPTION AS DESCRIPTION_I_OR_II,
				AU.PARAM1_VALUE,
				AU.MODIFIED_TIME,
				AU.PARAM0_VALUE
			FROM AUDIT_DETAILS AU
				JOIN STUDENT_SUB_TERM_MARK STUSUB ON AU.PARAM0_VALUE = STUSUB.STUDENT_SUB_TERM_MARK_ID 
				JOIN STUDENT_TERM_MARK STU ON STUSUB.STUDENT_TERM_MARKS_ID= STU.STUDENT_TERM_MARKS_ID 
				JOIN SUB_TERM SUBT ON STUSUB.SUB_TERM_ID=SUBT.SUB_TERM_ID
				JOIN STUDENT_CLASS_INFO STCL ON STU.STUDENT_CLASS_INFO_ID=STCL.STUDENT_CLASS_INFO_ID
				JOIN STUDENT S ON STCL.STUDENT_ID = S.STUDENT_ID JOIN GRADE_SUBJECT GRD ON STU.GRADE_SUBJECT_ID = GRD.GRADE_SUBJECT_ID JOIN
				SUBJECT SUB ON GRD.SUBJECT_ID=SUB.SUBJECT_ID 
			WHERE (? = '' OR AU.USER_NAME = ?) AND (? = '' OR AU.MODIFIED_TIME >= ?) AND (? = '' OR AU.MODIFIED_TIME <= ?)  AND STCL.CLASS_GRADE_ID = ?
			AND STCL.YEAR = ? AND STU.TERM_ID=?	AND AU.AUDIT_CATEGORY_ID = 2
			ORDER BY AU.MODIFIED_TIME DESC
			
					
		]]>
    </sql-query>
    
    <sql-query name="getPriviouseValueForSubTermMark">
		<![CDATA[
			SELECT PARAM1_VALUE
			FROM AUDIT_DETAILS
			WHERE AUDIT_DETAILS.AUDIT_CATEGORY_ID=2 AND AUDIT_DETAILS.PARAM0_VALUE= ? AND
			AUDIT_DETAILS.MODIFIED_TIME < ?
			ORDER BY AUDIT_DETAILS.MODIFIED_TIME DESC
			
					
		]]>
    </sql-query>
	
	<sql-query name="getAuditDetailsListForSubTermMarkGradeType">
		<![CDATA[
			SELECT
				AU.USER_NAME,
				S.ADMISSION_NO,
				S.NAME_WT_INITIALS,
				SUB.DESCRIPTION,
				SUBT.DESCRIPTION AS DESCRIPTION_I_OR_II,
				GR.GRADE_ACRONYM,
				AU.MODIFIED_TIME,
				AU.PARAM0_VALUE
			FROM AUDIT_DETAILS AU 
				JOIN STUDENT_SUB_TERM_MARK STUSUB ON
				AU.PARAM0_VALUE = STUSUB.STUDENT_SUB_TERM_MARK_ID 
				JOIN STUDENT_TERM_MARK STU ON STUSUB.STUDENT_TERM_MARKS_ID= STU.STUDENT_TERM_MARKS_ID 
				JOIN SUB_TERM SUBT ON STUSUB.SUB_TERM_ID=SUBT.SUB_TERM_ID
				JOIN STUDENT_CLASS_INFO STCL ON STU.STUDENT_CLASS_INFO_ID=STCL.STUDENT_CLASS_INFO_ID
				JOIN STUDENT S ON STCL.STUDENT_ID = S.STUDENT_ID JOIN GRADE_SUBJECT GRD ON STU.GRADE_SUBJECT_ID = GRD.GRADE_SUBJECT_ID JOIN
				SUBJECT SUB ON GRD.SUBJECT_ID=SUB.SUBJECT_ID LEFT JOIN GRADING GR ON GR.GRADING_ID =STUSUB.GRADING_ID
			WHERE AU.USER_NAME = ? AND AU.AUDIT_CATEGORY_ID=2
			ORDER BY AU.MODIFIED_TIME DESC
			
		]]>
	</sql-query>
	
	
	</hibernate-mapping>